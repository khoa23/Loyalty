@{
    ViewData["Title"] = "Quản lý quà";
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Quản lý quà</h2>
        <div>
            <a asp-action="Create" asp-controller="Admin" class="btn btn-primary ms-2">
                <i class="bi bi-plus-circle"></i> Thêm quà mới
            </a>
        </div>
    </div>

    @if (ViewBag.ErrorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            @ViewBag.ErrorMessage
        </div>
    }

    <div id="rewardsContainer">
        <div class="text-center mt-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

<form id="deleteForm" method="post" style="display: none;">
    <input type="hidden" name="rewardId" id="deleteRewardId" />
</form>

@section Scripts {
    <script>
        // Get base path from current URL to support subdirectories (e.g., /loyaltyWebApp/)
        function getBasePath() {
            const url = new URL(window.location.href);
            const pathname = url.pathname;
            
            // If path contains /Admin, extract base path up to that point
            const adminIndex = pathname.indexOf('/Admin');
            if (adminIndex > 0) {
                return pathname.substring(0, adminIndex);
            }
            return '';
        }

        const basePath = getBasePath();

        function deleteReward(rewardId, rewardName) {
            if (confirm(`Bạn có chắc chắn muốn xóa quà "${rewardName}"?`)) {
                document.getElementById('deleteRewardId').value = rewardId;
                document.getElementById('deleteForm').submit();
            }
        }

        function loadPage(page) {
            const apiUrl = basePath + '/Reward/GetAdminRewards?page=' + page;
            fetch(apiUrl)
                .then(async response => {
                    if (!response.ok) {
                        const text = await response.text();
                        console.error('Server Error:', text);
                        throw new Error('Lỗi tải dữ liệu (' + response.status + ')');
                    }
                    return response.text();
                })
                .then(html => {
                    document.getElementById('rewardsContainer').innerHTML = html;
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('rewardsContainer').innerHTML = '<div class="alert alert-danger">Không thể tải danh sách quà.<br>' + error.message + '</div>';
                });
        }

        document.addEventListener('DOMContentLoaded', () => loadPage(1));
    </script>
}
